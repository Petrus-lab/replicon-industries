<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Replicon Local AI Runner</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body.dark-mode { background: #23272e; color: #e5e5e5; }
    #container { max-width: 750px; margin: 2em auto; padding: 2em; border-radius: 14px; background: #fff; box-shadow: 0 2px 16px #0002;}
    body.dark-mode #container { background: #2d323c; }
    .output-render { border: 1px solid #bbb; background: #fafafa; min-height: 80px; padding: 1em; border-radius: 6px; font-family: monospace; }
    body.dark-mode .output-render { background: #22252b; color: #f3f3f3; border: 1px solid #333; }
    .statusbar { display: flex; gap: 1em; margin-bottom: 1em; font-size: .9em; }
    .status-ok { color: #2cc36b; }
    .status-missing { color: #ee3030; }
    .action-templates { display: flex; gap: 1em; margin-bottom: 1em; }
    .history-list { font-size: .97em; margin-top: 1em; }
    .history-list li { cursor: pointer; }
    .toast { position: fixed; z-index: 999; bottom: 30px; left: 50%; transform: translateX(-50%); background: #23272e; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 2px 10px #0004; font-size: 1.05em; opacity: 0; pointer-events: none; transition: opacity .3s; }
    .toast.show { opacity: 1; pointer-events: auto; }
    .spinner { display: inline-block; width: 28px; height: 28px; border: 4px solid #eee; border-top: 4px solid #0099ff; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .dark-toggle { float: right; margin-top: -3em; }
    .logo { font-size: 2em; letter-spacing: .1em; font-weight: 700; color: #0099ff; }
    .button-row, .test-buttons, .output-controls { margin: 12px 0; }
  </style>
</head>
<body>
  <div id="container">
    <span class="logo">Replicon AI Runner</span>
    <button class="dark-toggle" onclick="toggleDarkMode()">🌗 Dark Mode</button>
    <div class="statusbar" id="statusbar">Checking integrations...</div>

    <label for="actionType">Select Action Type:</label>
    <select id="actionType" onchange="showTemplates()">
      <option value="shell">Run Shell Command</option>
      <option value="python">Run Python</option>
      <option value="read">Read File</option>
      <option value="write">Write File</option>
      <option value="json">Run JSON</option>
    </select>
    <div class="action-templates" id="templates"></div>

    <label for="inputBox">Input:</label>
    <textarea id="inputBox" placeholder="Enter command, file path, or JSON payload here..."></textarea>

    <div class="button-row">
      <button onclick="submitToRunner()">🚀 Submit to Runner</button>
      <button onclick="clearInput()">🧹 Clear Input</button>
      <button onclick="clearOutput()">🧹 Clear Output</button>
      <button onclick="openHelp()">📖 Help</button>
    </div>
    <div class="test-buttons">
      <button onclick="testFirebase()">✅ Test Firebase</button>
      <button onclick="testGitHub()">✅ Test GitHub</button>
      <button onclick="testVercel()">✅ Test Vercel</button>
    </div>
    <div class="output-controls">
      <button onclick="copyOutput()">📋 Copy Output</button>
      <button onclick="saveOutputToFile()">💾 Save Output to File</button>
    </div>
    <label for="outputBox">Output:</label>
    <textarea id="outputBox" readonly></textarea>
    <div class="output-render" id="outputRender"></div>

    <div>
      <h3>History <small>(last 5)</small></h3>
      <ol class="history-list" id="historyList"></ol>
    </div>
    <div id="spinner" style="display:none;"><span class="spinner"></span> Working...</div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    // ========== 1. Status Bar: Check .env integrations ==========
    async function checkStatusBar() {
      let res = await fetch("http://localhost:3001/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "test_all_integrations", targets: ["firebase","github","vercel"] })
      });
      let data = await res.json();
      let html = "";
      // Replace these 3 lines only inside checkStatusBar()! this fix was sucses full
      html += /✅\s*Firebase/i.test(data.output) ? `<span class='status-ok'>Firebase ✓</span>` : `<span class='status-missing'>Firebase ✗</span>`;
      html += /✅\s*GitHub/i.test(data.output) ? `<span class='status-ok'>GitHub ✓</span>` : `<span class='status-missing'>GitHub ✗</span>`;
      html += /✅\s*Vercel/i.test(data.output) ? `<span class='status-ok'>Vercel ✓</span>` : `<span class='status-missing'>Vercel ✗</span>`;

      document.getElementById("statusbar").innerHTML = html;
    }
    checkStatusBar();

    // ========== 2. Action Templates ==========
    const templates = {
      shell: ["ls", "dir", "echo 'Hello World'"],
      python: ["print('Hello from Python!')"],
      read: ["ai-interface/index.html", "file outputs/output.txt"],
      write: [`{
  "filename": "file outputs/test.md",
  "content": "## Example Markdown\\nHello world!"
}`],
      json: [`{
  "type": "shell",
  "command": "ls"
}`,
`{
  "type": "python",
  "command": "print('Hello from JSON Python!')"
}`]
    };
    function showTemplates() {
      const action = document.getElementById("actionType").value;
      const area = document.getElementById("templates");
      area.innerHTML = "";
      (templates[action] || []).forEach(t => {
        let btn = document.createElement("button");
        btn.innerText = "Insert Example";
        btn.onclick = () => { document.getElementById("inputBox").value = t; };
        area.appendChild(btn);
      });
    }
    showTemplates();

    // ========== 3. Output and History ==========
    let history = [];
    function pushHistory(input, output) {
      history.unshift({ input, output, time: new Date().toLocaleTimeString() });
      if (history.length > 5) history.pop();
      updateHistoryView();
    }
    function updateHistoryView() {
      let list = document.getElementById("historyList");
      list.innerHTML = "";
      history.forEach((h, i) => {
        let item = document.createElement("li");
        item.innerHTML = `[${h.time}] <code>${h.input.replace(/</g,"&lt;").replace(/>/g,"&gt;").slice(0, 40)}${h.input.length>40?'...':''}</code>`;
        item.onclick = () => {
          document.getElementById("inputBox").value = h.input;
          document.getElementById("outputBox").value = h.output;
          renderOutput(h.output);
        };
        list.appendChild(item);
      });
    }

    // ========== 4. Submit & Spinner ==========
    function submitToRunner() {
      const action = document.getElementById("actionType").value;
      const input = document.getElementById("inputBox").value.trim();
      let payload = { action };

      if (["shell", "python"].includes(action)) {
        if (!confirm("Are you sure you want to run this " + action + " code?")) return;
      }

      switch (action) {
        case "shell":
        case "python":
          payload.inputData = input;
          break;
        case "read":
          payload.targetPath = input;
          break;
        case "write":
          try { JSON.parse(input); payload.inputData = input; }
          catch (e) { showToast("Write File input must be valid JSON."); return; }
          break;
        case "json":
          try { JSON.parse(input); payload.raw = input; }
          catch (e) { showToast("Run JSON input must be valid JSON."); return; }
          break;
        default:
          payload.inputData = input;
      }

      showSpinner(true);
      fetch("http://localhost:3001/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("outputBox").value = data.output;
        renderOutput(data.output);
        pushHistory(input, data.output);
        showToast("Done!");
        showSpinner(false);
      })
      .catch(error => {
        document.getElementById("outputBox").value = "❌ Error: " + error;
        renderOutput("❌ Error: " + error);
        showToast("Failed: " + error, true);
        showSpinner(false);
      });
    }

    function renderOutput(output) {
      const el = document.getElementById("outputRender");
      if (!output) { el.innerHTML = ""; return; }
      // JSON prettify
      try {
        let asObj = JSON.parse(output);
        el.innerHTML = "<pre>" + JSON.stringify(asObj, null, 2) + "</pre>";
        return;
      } catch(e){}
      // Markdown render (simple)
      if (/^#{1,6} /.test(output) || /\*\*/.test(output)) {
        el.innerHTML = marked(output);
        return;
      }
      // Otherwise
      el.innerHTML = "<pre>" + output.replace(/</g,"&lt;").replace(/>/g,"&gt;") + "</pre>";
    }

    function clearInput() { document.getElementById("inputBox").value = ""; }
    function clearOutput() { document.getElementById("outputBox").value = ""; document.getElementById("outputRender").innerHTML = ""; }

    // ========== 5. Test Buttons ==========
    function testFirebase() { runTest({ action: "test_all_integrations", targets: ["firebase"] }); }
    function testGitHub()   { runTest({ action: "test_all_integrations", targets: ["github"] }); }
    function testVercel()   { runTest({ action: "test_all_integrations", targets: ["vercel"] }); }
    function runTest(payload) {
      showSpinner(true);
      fetch("http://localhost:3001/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("outputBox").value = data.output;
        renderOutput(data.output);
        pushHistory(JSON.stringify(payload), data.output);
        showToast("Integration tested!");
        showSpinner(false);
        checkStatusBar(); // <--- Tweak: re-check status bar after each test
      })
      .catch(error => {
        document.getElementById("outputBox").value = "❌ Error: " + error;
        renderOutput("❌ Error: " + error);
        showToast("Failed: " + error, true);
        showSpinner(false);
        checkStatusBar(); // re-check even after error
      });
    }

    // ========== 6. Output Controls ==========
    function copyOutput() {
      const output = document.getElementById("outputBox").value;
      if (!output) { showToast("No output to copy!"); return; }
      navigator.clipboard.writeText(output).then(
        () => showToast("Output copied to clipboard!"),
        () => showToast("Failed to copy output.", true)
      );
    }
    function saveOutputToFile() {
      const output = document.getElementById("outputBox").value;
      if (!output) { showToast("No output to save!"); return; }
      let filename = prompt("Enter filename (e.g. output.txt or info.md):", "output.txt");
      if (!filename) return;
      if (!filename.startsWith("file outputs/")) filename = "file outputs/" + filename;
      const payload = {
        action: "write",
        inputData: JSON.stringify({ filename, content: output })
      };
      showSpinner(true);
      fetch("http://localhost:3001/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => { showToast(data.output); showSpinner(false); })
      .catch(error => { showToast("❌ Error saving output: " + error, true); showSpinner(false); });
    }

    // ========== 7. Help/Cheatsheet ==========
    function openHelp() {
      const cheatsheet = `
**Quick Cheatsheet:**

- **Shell**: e.g. \`ls\` or \`dir\`
- **Python**: e.g. \`print("Hello from Python!")\`
- **Read File**: e.g. \`ai-interface/index.html\`
- **Write File**: \`{ "filename": "file outputs/test.md", "content": "Hello" }\`
- **Run JSON**: \`{ "type": "shell", "command": "ls" }\`
- Use the Test buttons to check platform integrations.
- Use the history to recall and rerun previous inputs.
- Use the Copy/Save buttons for output sharing.

**Security tip:** Never expose this UI/server to the public internet!

_This help will show if operators-manual.md is not found._
      `;
      showSpinner(true);
      fetch("http://localhost:3001/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "read", targetPath: "operators-manual.md" }),
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("outputBox").value = data.output || cheatsheet;
        renderOutput(data.output || cheatsheet);
        showSpinner(false);
      })
      .catch(_ => {
        document.getElementById("outputBox").value = cheatsheet;
        renderOutput(cheatsheet);
        showSpinner(false);
      });
    }

    // ========== 8. Spinner & Toast ==========
    function showSpinner(on) { document.getElementById("spinner").style.display = on ? "block" : "none"; }
    function showToast(msg, error) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.style.background = error ? "#d23c2c" : "#23272e";
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2200);
    }

    // ========== 9. Dark Mode ==========
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("replicon-dark", document.body.classList.contains("dark-mode") ? "1" : "0");
    }
    // Restore dark mode on load
    if(localStorage.getItem("replicon-dark")==="1") document.body.classList.add("dark-mode");

    // ========== 10. Markdown rendering (minimal) ==========
    function marked(md) {
      if (!md) return "";
      let html = md
        .replace(/^###### (.*)$/gm, "<h6>$1</h6>")
        .replace(/^##### (.*)$/gm, "<h5>$1</h5>")
        .replace(/^#### (.*)$/gm, "<h4>$1</h4>")
        .replace(/^### (.*)$/gm, "<h3>$1</h3>")
        .replace(/^## (.*)$/gm, "<h2>$1</h2>")
        .replace(/^# (.*)$/gm, "<h1>$1</h1>")
        .replace(/\*\*(.+?)\*\*/g, "<b>$1</b>")
        .replace(/`([^`]+)`/g, "<code>$1</code>")
        .replace(/^- (.*)$/gm, "<li>$1</li>")
        .replace(/\n/g, "<br>");
      return html;
    }
  </script>

<script>
document.getElementById('shutdown-backend-btn').onclick = async function() {
    try {
        const res = await fetch('http://localhost:3001/shutdown', { method: 'POST' });
        const data = await res.json();
        const out = document.getElementById('output-box');
        out.value += '\n' + data.message;
        out.scrollTop = out.scrollHeight;
    } catch (e) {
        const out = document.getElementById('output-box');
        out.value += '\n[Error]: Unable to contact backend for shutdown.';
        out.scrollTop = out.scrollHeight;
    }
};
</script>


<script>
document.getElementById('shutdownBtn').onclick = async function() {
  const res = await fetch('http://localhost:3001/shutdown', { method: 'POST' });
  const data = await res.json();
  var obox = document.getElementById('output-box');
  obox.value += "\n[Backend] " + data.message;
  obox.scrollTop = obox.scrollHeight;
};
</script>


<script>
document.getElementById('restartBtn').onclick = async function() {
  const res = await fetch('http://localhost:3001/restart', { method: 'POST' });
  const data = await res.json();
  var obox = document.getElementById('output-box');
  obox.value += "\n[Backend] " + data.message;
  obox.scrollTop = obox.scrollHeight;
};
</script>


<script>
document.getElementById('shutdownBtn').onclick = async function() {
  const res = await fetch('http://localhost:3001/shutdown', { method: 'POST' });
  const data = await res.json();
  var obox = document.getElementById('output-box');
  obox.value += "\n[Backend] " + data.message;
  obox.scrollTop = obox.scrollHeight;
};
document.getElementById('restartBtn').onclick = async function() {
  const res = await fetch('http://localhost:3001/restart', { method: 'POST' });
  const data = await res.json();
  var obox = document.getElementById('output-box');
  obox.value += "\n[Backend] " + data.message;
  obox.scrollTop = obox.scrollHeight;
};
document.getElementById('restartUiBtn').onclick = async function() {
  const res = await fetch('http://localhost:3001/restart-ui', { method: 'POST' });
  const data = await res.json();
  var obox = document.getElementById('output-box');
  obox.value += "\n[UI Server] " + data.message;
  obox.scrollTop = obox.scrollHeight;
};
</script>

</body>
</html>
